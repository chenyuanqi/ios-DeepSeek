# DeepSeek AI 聊天应用

这是一个仿 DeepSeek AI 官方应用的聊天界面实现，使用 SwiftUI 开发，并集成了 DeepSeek AI API。

## 功能特性

1. **用户认证系统**
   - 支持基于邮箱的注册和登录
   - 登录状态持久化存储
   - 密码安全显示和隐藏切换
   - 表单验证和错误提示
   - 用户个人资料管理
   - **真实API对接**：与后端服务器API完全对接
   - **模拟API模式**：支持开发环境下的模拟数据

2. **聊天功能**
   - 用户可以输入消息并获得实时 AI 回复
   - 支持消息气泡展示，区分用户和 AI 消息
   - 支持默认提示问题的快速发送
   - 集成 DeepSeek API 提供真实的 AI 回复
   - **实时流式响应**：AI回复实时展示，一边请求一边显示结果
   - **打字效果**：带有打字光标动画，提供更加自然的交互体验
   - **模型切换**：支持在常规模式和深度思考模式之间切换

3. **聊天历史记录**
   - 自动保存对话历史
   - 按日期分组展示历史对话
   - 支持对话查询和删除
   - **精确时间显示**：显示每次对话的具体时间（如今天 15:30）
   - **对话预览**：点击历史记录可展开查看对话内容预览
   - **快速访问**：可直接从预览跳转到完整对话

4. **用户体验增强**
   - 思考动画：AI回复前显示动态"思考中"提示
   - 响应格式优化：确保无空行，更好的显示效果
   - 详细日志记录：便于开发者调试
   - 网络错误处理：友好的错误提示
   - **功能提示**：未实现功能（如联网）点击时显示友好提示
   - **流畅滚动**：接收流式响应时自动平滑滚动到最新内容

5. **用户界面**
   - 符合 iOS 设计规范的用户界面
   - 加载状态和错误处理
   - 流畅的动画和交互效果
   - 支持自适应布局

## 项目结构

项目采用 MVVM 架构模式组织代码：

- **Views**: 包含所有视图组件
  - `LoginView.swift`: 登录注册界面
  - `ChatView.swift`: 主聊天界面
  - `ChatHistoryView.swift`: 聊天历史记录界面
  - 其他自定义组件

- **ViewModels**: 包含业务逻辑
  - `AuthViewModel.swift`: 管理认证状态和用户信息
  - `ChatViewModel.swift`: 管理聊天和历史记录

- **Models**: 包含数据模型
  - `User.swift`: 用户模型和认证错误类型
  - `Message.swift`: 定义消息和对话数据结构

- **Services**: 包含服务层
  - `APIService.swift`: 处理与 DeepSeek API 的通信，支持标准请求和流式请求
  - `UserAPIService.swift`: 处理用户认证相关的API请求

- **Extension**: 包含Swift扩展
  - `InfoPlist.swift`: App配置文件扩展

## API 集成

应用集成了 DeepSeek API 和用户认证API：

- 使用 Combine 框架处理异步网络请求
- 实现错误处理和加载状态显示
- 支持多轮对话
- **增强的流式响应**：使用自定义 Publisher 和 Subscription 实现逐字显示效果，实时更新UI
- **模型切换**：支持在DeepSeek-V3和DeepSeek-R1模型间切换
- **支持RESTful API**：使用标准RESTful API进行用户认证和管理

## 网络请求日志

应用实现了详细的API请求日志记录功能：

1. **请求日志**：记录请求开始、请求体大小和使用模型等信息
2. **网络连接状态**：记录连接状态和错误信息
3. **HTTP响应**：记录HTTP状态码和内容大小
4. **数据解析**：记录数据流解析过程和结果
5. **错误处理**：详细的错误日志记录和用户友好的错误提示
6. **流式数据跟踪**：详细记录流式数据接收和处理过程
7. **认证状态跟踪**：记录用户登录状态变化和会话恢复过程

## 用户认证功能

为提供安全的用户体验：

1. **登录界面**：提供电子邮件和密码输入
2. **注册功能**：自动切换到注册模式，收集用户名、邮箱和密码
3. **密码安全**：支持密码显示/隐藏切换，确保安全输入
4. **表单验证**：所有字段的实时验证和错误提示
5. **个性化欢迎**：登录后显示个性化欢迎信息
6. **用户菜单**：支持查看个人资料和退出登录
7. **安全存储**：使用UserDefaults安全存储登录状态
8. **令牌管理**：管理认证令牌的存储、验证和刷新
9. **开发模式**：支持在真实API和模拟API之间切换

## 用户等待体验优化

为了提升用户等待AI回复的体验：

1. **动态思考提示**：随机显示不同的思考提示，如"正在思考"、"深入分析中"等
2. **点状动画**：思考提示末尾的点数动态变化，增强视觉反馈
3. **平滑过渡**：从等待状态到收到第一个响应块时的平滑过渡
4. **进度指示器**：在等待过程中显示活动指示器
5. **显示优化**：优化消息内容显示，确保无前导空行，提升阅读体验

## 流式响应优化

为提供更自然的对话体验：

1. **实时显示**：一边接收API响应一边更新UI，无需等待完整响应
2. **逐字显示**：模拟真人打字效果，文字逐个显示
3. **打字光标**：在文本末尾显示闪烁的打字光标
4. **自动滚动**：接收新内容时自动平滑滚动到最新位置
5. **详细日志**：记录每个内容块的接收与处理过程
6. **错误处理**：增强的错误处理和内容验证机制

## 聊天历史记录优化

为提供更好的历史对话浏览体验：

1. **对话标题**：使用用户的第一条消息作为对话标题，方便识别对话内容
2. **详细时间显示**：显示对话发生的具体时间（如"今天 15:30"、"昨天 09:45"）
3. **消息数量指示**：显示每个对话包含的消息数量
4. **对话预览功能**：
   - 点击对话可展开查看部分消息内容
   - 展开视图中区分用户和AI消息，并显示发送者图标
   - 长对话提供"查看完整对话"按钮
5. **快速操作**：提供"继续对话"按钮，方便快速回到之前的对话

## 使用方法

1. **注册和登录**
   - 首次使用时，输入邮箱、用户名和密码注册账号
   - 已有账号时，使用邮箱和密码登录
   - 通过右上角的用户图标菜单可退出登录

2. **发送消息**
   - 在底部输入框中输入内容并点击发送按钮
   - 或点击预设问题直接发送
   - 享受 AI 实时流式回复的打字机效果

3. **查看历史记录**
   - 点击左上角菜单按钮打开历史记录
   - 可搜索或按时间查看历史对话
   - 点击对话行可展开查看对话内容预览
   - 点击"继续对话"或"查看完整对话"进入完整对话界面

4. **模型切换**
   - 点击底部"RI • 深度思考"按钮切换模型
   - 蓝色状态表示启用深度思考模式(R1模型)
   - 灰色状态表示使用标准模式(V3模型)

5. **开发模式**
   - 在DEBUG构建中，点击顶部工具栏中的齿轮图标
   - 可以在真实API和模拟API之间切换
   - 模拟API模式无需后端服务器即可测试全部功能

## 用户体验优化

应用在多个方面进行了用户体验优化：

1. **登录体验优化**：
   - **无闪烁启动**：改进登录流程，已登录用户打开应用不会看到登录页面闪烁
   - **平滑过渡**：采用渐变动画在登录状态变化时提供流畅视觉体验
   - **背景认证检查**：将用户认证检查放在主界面加载后进行，提升启动速度
   - **延迟验证**：使用短暂延迟确保UI状态平稳过渡，避免界面跳动

2. **智能化界面**：
   - **上下文感知**：界面元素根据当前状态智能显示或隐藏
   - **流畅动画**：所有状态变化都添加适当的动画效果
   - **减少等待感**：在后台进行认证操作，前台保持界面响应

3. **状态管理优化**：
   - **分离UI与认证**：将UI状态与认证状态解耦，提高代码可维护性
   - **专用状态跟踪**：通过独立状态变量跟踪认证检查过程
   - **清晰的状态转换**：定义明确的状态转换逻辑

## 最近更新

1. **逐字显示优化**：增强AI回复的打字机效果，实现更自然的逐字显示动画，提升对话真实感
2. **登录体验优化**：优化应用启动流程，避免已登录用户看到登录页面闪烁，提供更流畅的启动过程
3. **UI精简**：隐藏顶部"元气大宝"标题，使界面更加简洁清爽
4. **UI优化**：隐藏记忆策略按钮，简化界面，减少用户选择负担
5. **Markdown支持**：AI回复内容支持Markdown格式，可以展示标题、列表、代码块等富文本格式
6. **深色模式优化**：增强深色模式下的文字可读性和界面对比度，优化所有UI组件在夜间使用的舒适度
7. **深色模式支持**：全面适配iOS深色模式，支持系统/浅色/深色三种显示模式，提升夜间使用体验
8. **添加用户资料编辑功能**：实现用户昵称修改，提升个人信息管理能力
9. **UI空间优化**：隐藏"联网"按钮，减少底部工具栏拥挤，保持界面简洁
10. **增强对话记忆能力**：实现智能上下文记忆功能，支持多种记忆策略，自动进行对话摘要和重要性分析
11. **优化界面布局**：将"新建对话"按钮从右上角移至功能按钮区，与"深度思考"按钮保持统一样式，提升用户体验
12. **修复历史记录保存问题**：解决了AI回复内容在历史记录中不完整的问题，确保对话完整保存
13. **强化流式响应处理**：优化AI回复内容的处理与保存逻辑，防止空消息保存，提高稳定性
14. **添加日志记录**：增加详细的对话保存状态日志，便于开发调试
15. **添加用户认证系统**：实现登录注册功能，支持用户个人资料管理
16. **接入RESTful API**：完成与后端服务器API的完整对接
17. **增强错误处理**：完善网络请求错误处理和用户友好的提示
18. **增强会话管理**：添加会话自动恢复和Token管理功能
19. **添加模拟API模式**：支持在开发环境中使用模拟数据进行测试
20. **增强表单验证**：实时验证表单输入，提供详细的错误提示
21. **优化用户界面**：个性化欢迎消息和用户菜单
22. **加强安全性**：改进密码处理和令牌存储机制

## 用户资料管理

为提升用户体验和个性化程度：

1. **个人资料编辑**：
   - 通过右上角头像菜单进入"修改个人资料"页面
   - 支持修改用户昵称，个性化应用体验
   - 表单实时验证，防止空昵称等错误输入
   - 提供加载状态指示和错误反馈

2. **增强用户反馈**：
   - 修改成功后实时更新UI界面，确保用户体验一致性
   - 友好的操作结果提示，增强用户信心
   - 保留取消编辑功能，避免误操作

3. **API集成**：
   - 完全集成用户系统API，支持真实后端交互
   - 支持模拟模式开发测试，提高开发效率
   - 详细的日志记录，便于调试和问题追踪

## 增强对话记忆能力

为提供更智能的对话体验，应用实现了先进的上下文记忆功能：

1. **多种记忆策略**：
   - **最近消息**：使用最近的固定数量消息作为上下文
   - **重要消息**：根据消息重要性智能选择上下文
   - **摘要上下文**：结合对话摘要和最近消息，提供更高效的上下文

2. **自动记忆优化**：
   - 消息重要性自动分析，给每条消息分配1-10分的重要性评分
   - 长对话自动生成摘要，捕捉关键信息
   - 对话主题自动提取，便于后期检索

3. **记忆策略选择**：
   - 通过记忆策略按钮随时切换不同的上下文策略
   - 为不同类型对话选择最合适的记忆模式
   - 系统会根据对话长度自动优化记忆方式

4. **智能上下文管理**：
   - 长对话自动压缩重要信息，确保API传输高效
   - 对话摘要定期更新，保持上下文准确性
   - 通过关键词提取实现更准确的主题关联

## 界面布局优化

为提升用户体验和界面一致性：

1. **功能按钮区整合**：
   - 将"新建对话"按钮从右上角移至功能按钮区，与其他功能按钮保持一致
   - 隐藏"联网"按钮，减少底部工具栏拥挤，保留核心功能按钮
   - 统一按钮样式，包含图标和文字说明，提高可识别性
   - 优化布局间距，使界面更加平衡和谐

2. **按钮样式统一**：
   - 所有功能按钮采用相同的圆角、内边距和背景色
   - 按钮文字大小和颜色保持统一
   - 活动状态使用蓝色背景标识，非活动状态使用灰色背景

3. **区域划分明确**：
   - 功能按钮区与输入区明确分离
   - 状态指示（如"R1模式"）放置在右侧，减少视觉干扰
   - 整体布局更符合用户操作习惯和iOS设计规范

## 代码质量改进

为提升应用的稳定性和可维护性：

1. **API错误修复**：
   - 修正APIService中关于字符串处理的编译错误
   - 优化可选值链式调用，避免在非可选类型上使用可选链
   - 增强数据处理的健壮性，确保类型安全

2. **代码清理**：
   - 使用注释而非删除代码的方式隐藏联网按钮，便于未来恢复
   - 优化按钮布局代码，提高可读性
   - 更新按钮位置相关注释，保持代码文档的准确性

3. **构建优化**：
   - 定期执行clean build，确保编译缓存不会引起问题
   - 解决所有编译警告，确保代码品质

## 未来改进计划

1. ~~添加流式响应支持（Stream API）~~ **已实现**
2. ~~添加模型切换功能~~ **已实现**
3. ~~优化用户等待体验~~ **已实现**
4. ~~增强历史记录功能~~ **已实现**
5. ~~优化流式响应体验~~ **已实现**
6. ~~添加用户认证系统~~ **已实现**
7. ~~接入RESTful API~~ **已实现**
8. ~~增强对话记忆能力~~ **已实现**
9. ~~添加用户资料编辑功能~~ **已实现**
10. ~~支持深色模式~~ **已实现**
11. ~~支持Markdown格式~~ **已实现**
12. 添加语音输入功能
13. 支持图片和文件的发送和接收
14. 实现本地模型运行
15. 用户界面进一步优化
    - 增加主题色定制
    - 支持更多字体大小选项

## 深色模式支持

为提供更舒适的视觉体验，应用全面支持深色模式：

1. **多种显示模式**：
   - **跟随系统**：自动根据iOS系统设置切换深色/浅色模式
   - **浅色模式**：始终使用浅色主题，适合白天使用
   - **深色模式**：始终使用深色主题，适合夜间使用，减少眼睛疲劳

2. **自适应界面元素**：
   - 所有界面元素（文本、背景、按钮等）根据当前模式自动调整颜色
   - 对比度经过精心设计，确保在任何模式下都能清晰阅读
   - 消息气泡、输入框、按钮等组件使用适合当前模式的颜色和阴影

3. **轻松切换**：
   - 通过个人资料菜单中的"外观设置"快速切换显示模式
   - 实时预览不同模式的效果
   - 设置自动保存，下次启动应用时保持相同的显示模式

4. **色彩系统**：
   - 采用自适应颜色系统，统一管理深浅色模式的颜色
   - 主题色在深色模式下自动调整亮度，确保视觉舒适度
   - 避免在深色模式下过于刺眼的高亮颜色
   
5. **深色模式优化**：
   - **功能按钮**：调整了底部功能按钮的颜色和背景，在深色模式下提供更高对比度
   - **消息气泡**：深色模式下使用更亮的背景色，确保文字易于阅读
   - **输入框**：增强了输入区域的可见性，使文字输入更加清晰
   - **示例问题**：优化了推荐问题的背景和文字颜色，避免深色背景下难以辨识
   - **打字光标**：在深色模式下将光标颜色改为白色，提高可见性
   - **时间标签**：调整了消息时间标签的颜色，使其在深色背景下更加明显
   - **欢迎文字**：优化了欢迎界面的文字颜色，避免深色模式下文字"隐形"
   - **菜单图标**：修改了左上角菜单按钮颜色，确保在深色背景下清晰可见
   - **聊天记录**：优化了聊天历史记录界面的标题、内容和背景颜色，增强深色模式下的可读性
   - **分类标题**：增强了聊天记录分类标题（今天、昨天、更早）的可见性
   - **空状态提示**：调整了无聊天记录时的提示文字和图标颜色

## Markdown内容支持

应用现在支持在AI回复中显示丰富的Markdown格式内容：

1. **多格式支持**：
   - **标题**：支持多级标题显示，使内容层次分明
   - **列表**：支持有序和无序列表，包括任务列表
   - **代码**：支持行内代码和多行代码块，自动应用适当的格式
   - **引用**：支持引用块，使引用内容直观区分
   - **链接**：支持自动识别和格式化链接
   - **强调**：支持粗体、斜体等文本强调
   - **表格**：支持表格数据的结构化展示

2. **深色模式适配**：
   - Markdown内容的颜色和样式自动适应当前的显示模式
   - 代码块在深色模式下有专门的配色方案，提高可读性
   - 保持整体视觉一致性，无论在浅色或深色模式下

3. **集成特点**：
   - 使用GitHub风格的Markdown渲染
   - 保持与聊天界面整体风格的一致性
   - 在消息预览和完整对话界面中均支持Markdown渲染

4. **使用体验**：
   - 无需特殊操作，AI回复自动以Markdown格式渲染
   - 支持流式响应，Markdown内容可实时渲染
   - 历史记录中也保持Markdown格式的显示

## 逐字显示效果

应用实现了更加真实的对话体验，通过优化AI回复的显示方式：

1. **打字机效果**：
   - **自然节奏**：AI回复内容以打字机效果逐字显示，模拟真人打字节奏
   - **动态光标**：显示过程中带有闪烁光标，增强真实感
   - **平滑过渡**：字符显示有细微动画，提供流畅自然的视觉体验
   - **适应内容**：无论长短内容都能自动调整显示速度

2. **技术实现**：
   - **细粒度控制**：通过字符级别的内容切分实现更精细的控制
   - **定时器机制**：利用Timer创建可控的字符显示节奏
   - **流式优化**：优化了API的流式响应处理，提升数据传输效率
   - **对Markdown兼容**：逐字显示支持Markdown格式内容的正确渲染

3. **用户体验提升**：
   - **减轻等待感**：用户无需等待完整回复，可边看边思考
   - **增强互动感**：模拟真人对话的节奏，提升用户参与感
   - **降低认知负担**：分批呈现信息，避免信息过载
   - **提升沉浸感**：更接近真实人机对话的体验 